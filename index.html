<html>

<head>
    <title>PG2_lab1_2_no_points</title>
    <meta name="author" content="Paweł Jędrzejczyk">
    <!-- <style>
        canvas {
            margin: auto;
            display: block;
        }
    </style> -->
</head>

<body>
<canvas id="myCanvas" width="800" height="600">
    Your browser does not support the canvas tag.
</canvas>
<script>
    let canvas = document.getElementById("myCanvas");
    let ctx = canvas.getContext("2d");
    let roadInterval;
    let keyboardEventListenerDown;
    let keyboardEventListenerUp;

    class Obstacle {
        x;
        y;
        width;
        height;
        color;

        constructor(x, y) {
            this.x = x + Math.floor((Math.random() * 10) + 1) * 23;
            this.y = y;
            this.height = 25;
            this.width = 60;
            this.color = "purple"
            this.draw()
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.width, this.height)
        }

    }

    class Bonus {
        x;
        y;
        width;
        height;
        color;

        constructor(x, y) {
            this.x = x + Math.floor((Math.random() * 10) + 1) * 27;
            this.y = y;
            this.height = 20;
            this.width = 20;
            this.color = "yellow"
            this.draw()
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.width, this.height)
        }

    }

    class RoadSegment {
        x;
        y;
        leftCurb;
        rightCurb;
        curbColor;
        width;
        height;
        obstacle;
        bonus;

        constructor(X, Y, curbColor, obstacle) {
            this.x = X;
            this.y = Y;
            this.width = 300;
            this.height = 60; // change do less
            this.curbColor = curbColor;
            if (obstacle > 90) {
                this.obstacle = new Obstacle(this.x, this.y)
            }else if (obstacle > 80){
                this.bonus = new Bonus(this.x, this.y)
            }
            this.draw()
        }

        draw() {
            ctx.fillStyle = 'grey';
            ctx.fillRect(this.x, this.y, this.width, this.height)
            this.leftCurb = new Curb(this.x - 20, this.y, this.curbColor);
            this.rightCurb = new Curb(this.x + this.width, this.y, this.curbColor);
            if (this.curbColor === 'white') {
                ctx.fillStyle = this.curbColor;
                ctx.fillRect(this.x + 145, this.y, 10, this.height)
            }
            if (this.obstacle) {
                this.obstacle.draw();
            }
            if(this.bonus){
                this.bonus.draw();
            }
        }

        move() {
            if (this.obstacle) {
                this.obstacle.y += 6;
            }
            if (this.bonus) {
                this.bonus.y += 6;
            }
            this.y = this.y + 6;
            this.draw();
        }

        getColor() {
            return this.curbColor;
        }

        getX() {
            return this.x;
        }
    }

    class Curb {
        x;
        y;
        width;
        height;
        color;

        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.width = 20;
            this.height = 60;
            this.draw()
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.width, this.height)
        }
    }

    class Background {
        color;

        constructor(color) {
            this.color = color;
            this.draw()
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

        }
    }

    class Wheel {
        x;
        y;
        height;
        width;
        color;

        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.height = 15;
            this.width = 8;
            this.color = 'black';
            this.draw();
        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.width, this.height)
        }
    }

    class Car {
        width;
        height;
        wheels;
        x;
        y;
        color;
        moveLeft;
        moveRight;
        wheels;


        constructor() {
            this.height = 60;
            this.width = 40;
            this.x = 380;
            this.y = 530;
            this.color = "cyan"
            this.moveLeft = false;
            this.moveRight = false;
            this.wheels = [
                new Wheel(this.x, this.y + 3),
                new Wheel(this.x, this.y + 45),
                new Wheel(this.x + 32, this.y + 3),
                new Wheel(this.x + 32, this.y + 45)
            ];


            this.draw();
            keyboardEventListenerDown = window.addEventListener("keydown", moveCarStart, true);
            keyboardEventListenerUp = window.addEventListener("keyup", moveCarStop, true);

        }

        draw() {
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.width, this.height);
            for (let i = 0; i < this.wheels.length; i++) {
                this.wheels[i].draw();
            }
        }

        checkCollision(item) {
            return !(this.x + this.width < item.x ||
                item.x + item.width < this.x ||
                this.y + this.height < item.y ||
                item.y + item.height < this.y);
        }

        changeX(value) {
            this.x += value;
            for (let i = 0; i < this.wheels.length; i++) {
                this.wheels[i].x += value;
            }
        }

        moveStart(key) {
            if (key.keyCode === 37) {
                this.moveLeft = true;
            }
            if (key.keyCode === 39) {
                this.moveRight = true;
            }

        }

        moveStop(key) {
            if (key.keyCode === 37) {
                this.moveLeft = false;
            }
            if (key.keyCode === 39) {
                this.moveRight = false;

            }

        }

    }
    class PointsCounter{
        x;
        y;
        value;
        color = "black";

        constructor() {
            this.x = 0;
            this.y = 0;
            this.value = 0;
            ctx.font = "35px Arial";
            this.draw()
        }
        draw(){
            ctx.fillStyle = this.color;
            ctx.textAlign = "center";
            ctx.fillText(Math.floor(this.value/10), canvas.width-60, 50);
        }
    }

    class Race {
        roadArray;
        car;
        background;
        moveCounter;
        turnCounter;
        turn;
        pointsCounter


        constructor() {
            this.car = new Car();
            this.moveCounter = 0;
            this.turnCounter = 0;
            this.turn = 0;
            this.background = new Background("green");
            this.pointsCounter = new PointsCounter();
            this.roadArray = [
                new RoadSegment(250, 540, "white"),
                new RoadSegment(250, 480, "red"),
                new RoadSegment(250, 420, "white"),
                new RoadSegment(250, 360, "red"),
                new RoadSegment(250, 300, "white"),
                new RoadSegment(250, 240, "red"),
                new RoadSegment(250, 180, "white"),
                new RoadSegment(250, 120, "red"),
                new RoadSegment(250, 60, "white"),
                new RoadSegment(250, 0, "red"),
                new RoadSegment(250, -60, "white")
            ];
        }

        // moveCar(e) {
        //     this.car.move(e);
        // }

        moveRoad() {
            this.moveCounter++;
            this.turnCounter++;
            if (this.turnCounter === 100) {
                this.turnCounter = 0
                this.turn = this.randRoadDirection();
            }
            this.background.draw();
            this.roadArray.forEach(this.moveRoadElement);
            if (this.car.moveLeft) {
                this.car.changeX(-3);
            }
            if (this.car.moveRight) {
                this.car.changeX(3);
            }
            this.car.draw();
            for (let j = 0; j < 3; j++) {
                if (this.car.checkCollision(this.roadArray[j].leftCurb) ||
                    this.car.checkCollision(this.roadArray[j].rightCurb))
                        {
                    this.car.color = 'pink';
                    this.car.draw();
                    clearInterval(roadInterval)
                }
                if(this.roadArray[j].obstacle){
                    if(this.car.checkCollision(this.roadArray[j].obstacle)){
                        this.car.color = 'pink';
                        this.car.draw();
                        clearInterval(roadInterval)
                    }
                }
                if(this.roadArray[j].bonus){
                    if(this.car.checkCollision(this.roadArray[j].bonus)){
                        this.pointsCounter.value += 1000;
                        this.roadArray[j].bonus = null;

                    }
                }
            }
            if (this.moveCounter === 10) {
                this.moveCounter = 0;
                this.roadArray.shift();
                var newX = this.roadArray[9].getX() + this.turn;
                if (newX < 20) {
                    newX = 20;
                } else if (newX > 400) {
                    newX = 400;
                }
                this.roadArray.push(new RoadSegment(newX, -60, this.roadArray[0].getColor(), Math.floor((Math.random() * 100) + 1)))
            }
            this.pointsCounter.value+= 1;
            this.pointsCounter.draw();
        }

        randRoadDirection() {
            let coin = Math.floor((Math.random() * 10) + 1);
            if (coin < 5) {
                return -4;
            } else if (coin < 9) {
                return 4;
            } else {
                return 0;
            }
        }

        moveRoadElement(item) {
            item.move();
        }
    }

    game = new Race();

    function aaa() {
        game.moveRoad();
    }

    function moveCarStart(e) {
        game.car.moveStart(e);
    }

    function moveCarStop(e) {
        game.car.moveStop(e);
    }

    roadInterval = window.setInterval(aaa, 10)
</script>

</body>

</html>
